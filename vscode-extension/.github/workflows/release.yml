name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.1.0

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: vscode-extension/package-lock.json

    - name: Install dependencies
      working-directory: vscode-extension
      run: |
        npm ci

    - name: Install vsce
      run: |
        npm install -g @vscode/vsce

    - name: Compile extension
      working-directory: vscode-extension
      run: |
        npm run compile

    - name: Package extension
      working-directory: vscode-extension
      run: |
        vsce package

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
        if [ -z "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: vscode-extension/*.vsix
        body: |
          ## AICode VSCode Extension ${{ steps.get_version.outputs.VERSION }}

          ### üì¶ Installation

          Download the `.vsix` file below and install it in VSCode:
          1. Open VSCode
          2. Go to Extensions (Cmd+Shift+X)
          3. Click "..." menu ‚Üí "Install from VSIX..."
          4. Select the downloaded file

          ### üìù Changes

          ${{ steps.changelog.outputs.CHANGELOG }}

          ### üîó Links

          - [Marketplace](https://marketplace.visualstudio.com/items?itemName=aicode.aicode-vscode) (if published)
          - [Documentation](../blob/main/vscode-extension/README.md)
          - [Setup Guide](../blob/main/vscode-extension/SETUP.md)
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Optional: Publish to VS Code Marketplace
    # Uncomment and configure VSCE_PAT secret to enable
    # - name: Publish to VS Code Marketplace
    #   working-directory: vscode-extension
    #   run: |
    #     vsce publish -p ${{ secrets.VSCE_PAT }}
    #   env:
    #     VSCE_PAT: ${{ secrets.VSCE_PAT }}
